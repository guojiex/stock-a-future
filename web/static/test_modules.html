<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模块化重构测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>🧪 Stock-A-Future 模块化重构测试</h1>
    
    <div class="test-section">
        <h2>模块加载测试</h2>
        <button onclick="testModuleLoading()">测试模块加载</button>
        <div id="moduleTestResult" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>类实例化测试</h2>
        <button onclick="testClassInstantiation()">测试类实例化</button>
        <div id="classTestResult" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>功能测试</h2>
        <button onclick="testFunctionality()">测试基本功能</button>
        <div id="functionalityTestResult" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>应用初始化测试</h2>
        <button onclick="testAppInitialization()">测试应用初始化</button>
        <div id="appTestResult" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>测试结果汇总</h2>
        <div id="summaryResult" class="test-result"></div>
    </div>

    <!-- 加载所有模块 -->
    <script src="js/core/client.js"></script>
    <script src="js/services/api.js"></script>
    <script src="js/modules/charts.js"></script>
    <script src="js/modules/stockSearch.js"></script>
    <script src="js/modules/config.js"></script>
    <script src="js/modules/display.js"></script>
    <script src="js/modules/events.js"></script>
    <script src="js/utils/helpers.js"></script>
    <script src="js/main.js"></script>

    <script>
        let testResults = {};

        function logResult(testName, success, message) {
            const status = success ? '✅ 通过' : '❌ 失败';
            const color = success ? 'success' : 'error';
            testResults[testName] = success;
            
            console.log(`${status} ${testName}: ${message}`);
            return `<div class="${color}">${status} ${testName}: ${message}</div>`;
        }

        function testModuleLoading() {
            const resultDiv = document.getElementById('moduleTestResult');
            let results = '<h3>模块加载测试结果:</h3>';
            
            // 测试核心模块
            if (typeof StockAFutureClient !== 'undefined') {
                results += logResult('StockAFutureClient', true, '核心客户端类加载成功');
            } else {
                results += logResult('StockAFutureClient', false, '核心客户端类加载失败');
            }

            if (typeof ApiService !== 'undefined') {
                results += logResult('ApiService', true, 'API服务类加载成功');
            } else {
                results += logResult('ApiService', false, 'API服务类加载失败');
            }

            if (typeof ChartsModule !== 'undefined') {
                results += logResult('ChartsModule', true, '图表模块类加载成功');
            } else {
                results += logResult('ChartsModule', false, '图表模块类加载失败');
            }

            if (typeof StockSearchModule !== 'undefined') {
                results += logResult('StockSearchModule', true, '股票搜索模块类加载成功');
            } else {
                results += logResult('StockSearchModule', false, '股票搜索模块类加载失败');
            }

            if (typeof ConfigModule !== 'undefined') {
                results += logResult('ConfigModule', true, '配置管理模块类加载成功');
            } else {
                results += logResult('ConfigModule', false, '配置管理模块类加载失败');
            }

            if (typeof DisplayModule !== 'undefined') {
                results += logResult('DisplayModule', true, '数据展示模块类加载成功');
            } else {
                results += logResult('DisplayModule', false, '数据展示模块类加载失败');
            }

            if (typeof EventsModule !== 'undefined') {
                results += logResult('EventsModule', true, '事件处理模块类加载成功');
            } else {
                results += logResult('EventsModule', false, '事件处理模块类加载失败');
            }

            if (typeof Helpers !== 'undefined') {
                results += logResult('Helpers', true, '工具函数类加载成功');
            } else {
                results += logResult('Helpers', false, '工具函数类加载失败');
            }

            if (typeof StockAFutureApp !== 'undefined') {
                results += logResult('StockAFutureApp', true, '主应用类加载成功');
            } else {
                results += logResult('StockAFutureApp', false, '主应用类加载失败');
            }

            resultDiv.innerHTML = results;
        }

        function testClassInstantiation() {
            const resultDiv = document.getElementById('classTestResult');
            let results = '<h3>类实例化测试结果:</h3>';
            
            try {
                // 测试核心客户端实例化
                const client = new StockAFutureClient();
                results += logResult('StockAFutureClient实例化', true, '核心客户端实例化成功');
                
                // 测试API服务实例化
                const apiService = new ApiService(client);
                results += logResult('ApiService实例化', true, 'API服务实例化成功');
                
                // 测试图表模块实例化
                const chartsModule = new ChartsModule(client);
                results += logResult('ChartsModule实例化', true, '图表模块实例化成功');
                
                // 测试其他模块实例化
                const displayModule = new DisplayModule(client, chartsModule);
                results += logResult('DisplayModule实例化', true, '数据展示模块实例化成功');
                
                const eventsModule = new EventsModule(client, apiService, displayModule);
                results += logResult('EventsModule实例化', true, '事件处理模块实例化成功');
                
                const stockSearchModule = new StockSearchModule(client, apiService);
                results += logResult('StockSearchModule实例化', true, '股票搜索模块实例化成功');
                
                const configModule = new ConfigModule(client);
                results += logResult('ConfigModule实例化', true, '配置管理模块实例化成功');
                
            } catch (error) {
                results += logResult('类实例化', false, `实例化过程中出现错误: ${error.message}`);
            }

            resultDiv.innerHTML = results;
        }

        function testFunctionality() {
            const resultDiv = document.getElementById('functionalityTestResult');
            let results = '<h3>功能测试结果:</h3>';
            
            try {
                // 测试工具函数
                const testNumber = 1234567.89;
                const formattedNumber = Helpers.formatNumber(testNumber);
                if (formattedNumber === '1,234,567.89') {
                    results += logResult('数字格式化', true, '数字格式化功能正常');
                } else {
                    results += logResult('数字格式化', false, '数字格式化功能异常');
                }

                // 测试货币格式化
                const formattedCurrency = Helpers.formatCurrency(testNumber);
                if (formattedCurrency.includes('¥1,234,567.89')) {
                    results += logResult('货币格式化', true, '货币格式化功能正常');
                } else {
                    results += logResult('货币格式化', false, '货币格式化功能异常');
                }

                // 测试百分比格式化
                const testPercent = 0.1234;
                const formattedPercent = Helpers.formatPercentage(testPercent);
                if (formattedPercent === '12.34%') {
                    results += logResult('百分比格式化', true, '百分比格式化功能正常');
                } else {
                    results += logResult('百分比格式化', false, '百分比格式化功能异常');
                }

                // 测试防抖函数
                let callCount = 0;
                const debouncedFunc = Helpers.debounce(() => callCount++, 100);
                debouncedFunc();
                debouncedFunc();
                debouncedFunc();
                
                setTimeout(() => {
                    if (callCount === 1) {
                        results += logResult('防抖函数', true, '防抖功能正常');
                    } else {
                        results += logResult('防抖函数', false, '防抖功能异常');
                    }
                }, 200);

            } catch (error) {
                results += logResult('功能测试', false, `功能测试过程中出现错误: ${error.message}`);
            }

            resultDiv.innerHTML = results;
        }

        function testAppInitialization() {
            const resultDiv = document.getElementById('appTestResult');
            let results = '<h3>应用初始化测试结果:</h3>';
            
            try {
                // 等待应用初始化
                setTimeout(() => {
                    if (window.stockApp) {
                        results += logResult('应用实例', true, '应用实例创建成功');
                        
                        // 测试各个模块的获取
                        const client = window.stockApp.getClient();
                        if (client) {
                            results += logResult('客户端获取', true, '客户端模块获取成功');
                        } else {
                            results += logResult('客户端获取', false, '客户端模块获取失败');
                        }

                        const apiService = window.stockApp.getApiService();
                        if (apiService) {
                            results += logResult('API服务获取', true, 'API服务模块获取成功');
                        } else {
                            results += logResult('API服务获取', false, 'API服务模块获取失败');
                        }

                        resultDiv.innerHTML = results;
                    } else {
                        results += logResult('应用实例', false, '应用实例创建失败');
                        resultDiv.innerHTML = results;
                    }
                }, 1000);

            } catch (error) {
                results += logResult('应用初始化', false, `应用初始化过程中出现错误: ${error.message}`);
                resultDiv.innerHTML = results;
            }
        }

        // 自动运行测试
        window.addEventListener('load', () => {
            setTimeout(() => {
                testModuleLoading();
                testClassInstantiation();
                testFunctionality();
                testAppInitialization();
                
                // 显示测试结果汇总
                setTimeout(() => {
                    const summaryDiv = document.getElementById('summaryResult');
                    const totalTests = Object.keys(testResults).length;
                    const passedTests = Object.values(testResults).filter(Boolean).length;
                    const failedTests = totalTests - passedTests;
                    
                    const summary = `
                        <h3>测试结果汇总:</h3>
                        <div class="success">总测试数: ${totalTests}</div>
                        <div class="success">通过: ${passedTests}</div>
                        <div class="${failedTests > 0 ? 'error' : 'success'}">失败: ${failedTests}</div>
                        <div class="info">成功率: ${((passedTests / totalTests) * 100).toFixed(1)}%</div>
                    `;
                    
                    summaryDiv.innerHTML = summary;
                }, 2000);
            }, 500);
        });
    </script>
</body>
</html>
