<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>策略编辑功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            display: inline-block;
            padding: 10px 20px;
            margin: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>策略编辑功能测试</h1>
        <p>这个页面用于测试策略编辑功能是否正常工作。</p>
        
        <h2>测试按钮</h2>
        <button class="test-button" onclick="testDirectCall()">直接调用 strategiesModule.editStrategy</button>
        <button class="test-button" onclick="testSafeCall()">安全调用 safeCallStrategy</button>
        <button class="test-button" onclick="checkModuleStatus()">检查模块状态</button>
        
        <h2>测试结果</h2>
        <div id="testResults"></div>
        
        <h2>模拟策略编辑按钮</h2>
        <button class="test-button" onclick="safeCallStrategy('editStrategy', 'ma_crossover')">
            ✏️ 编辑双均线策略
        </button>
        <button class="test-button" onclick="safeCallStrategy('editStrategy', 'macd_strategy')">
            ✏️ 编辑MACD策略
        </button>
    </div>

    <!-- 引入必要的脚本 -->
    <script src="web/static/js/utils/safe-call.js"></script>
    
    <script>
        function addResult(message, type = 'success') {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            resultsDiv.appendChild(resultDiv);
        }
        
        function testDirectCall() {
            try {
                if (window.strategiesModule && typeof window.strategiesModule.editStrategy === 'function') {
                    window.strategiesModule.editStrategy('ma_crossover');
                    addResult('直接调用成功', 'success');
                } else {
                    addResult('strategiesModule 不存在或方法不可用', 'error');
                }
            } catch (error) {
                addResult(`直接调用失败: ${error.message}`, 'error');
            }
        }
        
        function testSafeCall() {
            try {
                if (window.safeCallStrategy) {
                    window.safeCallStrategy('editStrategy', 'ma_crossover');
                    addResult('安全调用已执行', 'success');
                } else {
                    addResult('safeCallStrategy 函数不存在', 'error');
                }
            } catch (error) {
                addResult(`安全调用失败: ${error.message}`, 'error');
            }
        }
        
        function checkModuleStatus() {
            const results = [];
            
            // 检查 safeCall 工具
            if (window.safeCall) {
                results.push('✅ safeCall 工具已加载');
            } else {
                results.push('❌ safeCall 工具未加载');
            }
            
            if (window.safeCallStrategy) {
                results.push('✅ safeCallStrategy 函数已加载');
            } else {
                results.push('❌ safeCallStrategy 函数未加载');
            }
            
            // 检查 strategiesModule
            if (window.strategiesModule) {
                results.push('✅ strategiesModule 已初始化');
                if (typeof window.strategiesModule.editStrategy === 'function') {
                    results.push('✅ editStrategy 方法可用');
                } else {
                    results.push('❌ editStrategy 方法不可用');
                }
            } else {
                results.push('❌ strategiesModule 未初始化');
            }
            
            // 检查主应用
            if (window.stockApp) {
                results.push('✅ 主应用已初始化');
            } else {
                results.push('❌ 主应用未初始化');
            }
            
            results.forEach(result => {
                const type = result.startsWith('✅') ? 'success' : 'error';
                addResult(result, type);
            });
        }
        
        // 页面加载时自动检查状态
        window.addEventListener('load', () => {
            setTimeout(() => {
                addResult('页面加载完成，开始检查模块状态...', 'warning');
                checkModuleStatus();
            }, 1000);
        });
    </script>
</body>
</html>
