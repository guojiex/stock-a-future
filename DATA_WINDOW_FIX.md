# 技术指标数据窗口修复

## 🐛 问题描述

用户反馈在股票技术指标页面只显示了4个基础指标（MACD、RSI、布林带、KDJ），而新实现的13个技术指标都没有显示。

## 🔍 问题分析

经过分析发现，问题出现在默认的日线数据拉取窗口大小不足：

### 各技术指标的数据需求
- **MACD**: 需要至少26天数据
- **RSI**: 需要至少14天数据  
- **布林带**: 需要至少20天数据
- **KDJ**: 需要至少9天数据
- **一目均衡表(Ichimoku)**: 需要至少**52天**数据
- **历史波动率**: 需要至少**60天**数据
- **ADX**: 需要至少14天数据
- **其他新指标**: 大多需要14-26天数据

### 原始问题
- 系统默认只拉取**30天**数据
- 对于一目均衡表(52天)和历史波动率(60天)数据不足
- 导致这些指标无法计算，前端只显示基础指标

## ✅ 解决方案

### 1. 修改默认数据窗口大小
将默认日线数据拉取窗口从30天增加到**90天**：

```go
// internal/handler/stock.go
// 默认获取配置中指定天数的数据，确保所有技术指标都有足够的数据
// 一目均衡表需要52天，历史波动率需要60天，所以默认设置为90天比较安全
if startDate == "" {
    startDate = time.Now().AddDate(0, 0, -h.config.DefaultDataWindowDays).Format("20060102")
}
```

### 2. 添加配置选项
在配置文件中添加可自定义的数据窗口大小：

```go
// config/config.go
type Config struct {
    // ... 其他配置 ...
    
    // 数据窗口配置
    DefaultDataWindowDays int // 默认日线数据窗口大小（天数），默认90天
}
```

### 3. 更新配置文件
在`config.env`中添加新配置项：

```env
# 数据窗口配置 - 默认拉取90天数据确保所有技术指标都有足够数据
DEFAULT_DATA_WINDOW_DAYS=90
```

## 🧪 验证方法

使用测试脚本`test_indicators_api.go`验证所有17个技术指标都能正常计算：

```bash
go run test_indicators_api.go
```

预期结果：
- ✅ 所有17个技术指标都应该显示"已计算"
- 🎉 显示"所有技术指标都已成功计算！"

## 📊 技术指标列表

修复后应该能看到以下18个技术指标：

### 基础指标 (4个)
1. ✅ MACD - 移动平均收敛发散
2. ✅ RSI - 相对强弱指数  
3. ✅ 布林带 - Bollinger Bands
4. ✅ KDJ - 随机指标

### 动量因子 (4个)
5. ✅ 威廉指标 (%R)
6. ✅ 动量指标 (Momentum)
7. ✅ 变化率指标 (ROC)

### 趋势因子 (3个)
8. ✅ 平均方向指数 (ADX)
9. ✅ 抛物线转向 (SAR)
10. ✅ 一目均衡表 (Ichimoku)

### 波动率因子 (3个)
11. ✅ 平均真实范围 (ATR)
12. ✅ 标准差 (StdDev)
13. ✅ 历史波动率 (HV)

### 成交量因子 (4个)
14. ✅ 成交量加权平均价 (VWAP)
15. ✅ 累积/派发线 (A/D Line)
16. ✅ 简易波动指标 (EMV)
17. ✅ 量价确认指标 (VPT)

## 🎯 影响

- **用户体验**: 现在可以看到完整的18个技术指标
- **数据准确性**: 所有指标都有足够的历史数据进行计算
- **系统稳定性**: 避免了因数据不足导致的计算错误
- **可配置性**: 用户可以根据需要调整数据窗口大小

## 📝 注意事项

1. **数据量增加**: 从30天增加到90天，数据传输量增加约3倍
2. **缓存策略**: 建议启用缓存以提高性能
3. **API响应时间**: 可能会略有增加，但在可接受范围内
4. **存储空间**: 缓存数据占用空间会相应增加

## 🔧 后续优化建议

1. **按需加载**: 可以考虑根据用户选择的指标动态调整数据窗口
2. **分级缓存**: 对不同时间窗口的数据采用不同的缓存策略
3. **压缩传输**: 对大量历史数据进行压缩传输
4. **增量更新**: 实现增量数据更新机制
