# 数据清理功能说明

## 概述

Stock-A-Future系统提供了自动数据清理功能，用于定期清理数据库中的过期股票信号数据，防止数据库无限增长，保持系统性能。

## 功能特性

### 1. 自动清理
- **股票信号数据**: 自动清理超过指定天数的历史信号数据
- **定时执行**: 可配置的清理间隔，默认每天执行一次

### 2. 手动清理
- 支持手动触发数据清理任务
- 实时查看清理进度和结果

### 3. 配置管理
- 可动态调整清理间隔
- 可配置数据保留天数
- 支持运行时更新配置

## 配置选项

### 环境变量配置

在 `config.env` 文件中添加以下配置：

```bash
# 数据清理配置
CLEANUP_ENABLED=true           # 是否启用数据清理服务
CLEANUP_INTERVAL=24h           # 清理间隔，默认24小时
CLEANUP_RETENTION_DAYS=90      # 股票信号数据保留天数，默认90天
```

### 配置说明

- **CLEANUP_ENABLED**: 控制是否启用数据清理服务
- **CLEANUP_INTERVAL**: 清理任务执行间隔，支持Go时间格式（如：24h、12h、1h等）
- **CLEANUP_RETENTION_DAYS**: 股票信号数据保留天数，超过此天数的数据将被自动删除

## API接口

### 1. 获取清理服务状态

```http
GET /api/v1/cleanup/status
```

**响应示例:**
```json
{
  "enabled": true,
  "cleanup_interval": "24h0m0s",
  "retention_days": 90
}
```

### 2. 手动触发清理

```http
POST /api/v1/cleanup/manual
```

**响应示例:**
```json
{
  "message": "数据清理任务已启动，请查看服务器日志了解进度"
}
```

### 3. 更新清理配置

```http
PUT /api/v1/cleanup/config
Content-Type: application/json

{
  "cleanup_interval": "12h",
  "retention_days": 60
}
```

**响应示例:**
```json
{
  "message": "清理配置已更新"
}
```

## 使用示例

### 启用数据清理

1. 在 `config.env` 文件中设置：
```bash
CLEANUP_ENABLED=true
CLEANUP_INTERVAL=24h
CLEANUP_RETENTION_DAYS=90
```

2. 重启服务器，系统将自动启动数据清理服务

### 手动清理数据

```bash
# 手动触发清理
curl -X POST http://localhost:8080/api/v1/cleanup/manual

# 查看清理状态
curl http://localhost:8080/api/v1/cleanup/status

# 更新配置
curl -X PUT http://localhost:8080/api/v1/cleanup/config \
  -H "Content-Type: application/json" \
  -d '{"retention_days": 60}'
```

## 监控和日志

### 日志输出

数据清理服务会在服务器日志中输出详细的执行信息：

```
2024/01/01 10:00:00 启动数据清理服务，清理间隔: 24h0m0s
2024/01/01 10:00:00 开始执行数据清理任务...
2024/01/01 10:00:00 开始清理过期数据...
2024/01/01 10:00:00 股票信号数据保留天数: 90天
2024/01/01 10:00:00 清理了 15 条过期的股票信号数据
2024/01/01 10:00:00 过期数据清理完成
2024/01/01 10:00:00 数据库统计信息:
2024/01/01 10:00:00   favorite_groups_count: 3
2024/01/01 10:00:00   favorite_stocks_count: 25
2024/01/01 10:00:00   stock_signals_count: 1250
2024/01/01 10:00:00   database_size_mb: 15.2
2024/01/01 10:00:00   oldest_signal_date: 20241001
2024/01/01 10:00:00   newest_signal_date: 20241231
2024/01/01 10:00:00 数据清理任务完成，耗时: 45ms
```

### 性能监控

- 清理任务执行时间
- 删除的记录数量
- 数据库大小变化
- 各表记录数统计

## 注意事项

### 1. 数据安全
- 清理操作不可逆，请谨慎配置保留天数
- 建议先在测试环境验证配置
- 重要数据请提前备份

### 2. 性能考虑
- 清理任务在后台异步执行，不会阻塞API请求
- 大量数据清理时可能影响数据库性能
- 建议在业务低峰期执行清理任务

### 3. 配置建议
- **股票信号数据**: 建议保留30-90天，平衡存储空间和历史分析需求
- **清理间隔**: 建议24小时，避免过于频繁的清理操作

## 故障排除

### 常见问题

1. **清理服务未启动**
   - 检查 `CLEANUP_ENABLED` 配置是否为 `true`
   - 查看服务器启动日志

2. **清理失败**
   - 检查数据库连接状态
   - 查看错误日志信息
   - 验证数据库权限

3. **配置更新失败**
   - 检查请求格式和参数
   - 验证时间格式是否正确
   - 确认数值参数范围

### 日志分析

通过分析服务器日志可以了解：
- 清理任务的执行状态
- 删除的数据量统计
- 数据库性能指标
- 错误和异常信息

## 总结

数据清理功能是Stock-A-Future系统的重要组成部分，通过定期清理过期的股票信号数据，可以有效控制数据库大小，保持系统性能，为用户提供更好的使用体验。收藏数据不会被自动清理，确保用户的重要收藏信息得到保护。
