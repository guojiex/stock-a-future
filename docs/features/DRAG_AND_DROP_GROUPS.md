# 收藏分组拖拽功能说明

## 问题描述

之前用户反馈分组里面的股票不能拖动到其他分组，这是因为非激活的分组内容区域使用了 `display: none` 隐藏，导致无法接收拖拽事件。

## 解决方案

### 1. 拖拽到分组标签页（Tab）

**主要功能**：可以将股票直接拖拽到上方的分组标签页，实现跨分组移动。

**使用方法**：
1. 鼠标悬停在股票项左侧的拖拽手柄（⋮⋮）上
2. 按住鼠标左键开始拖拽
3. 将股票拖拽到目标分组的**标签页**上
4. 松开鼠标完成移动

**视觉反馈**：
- 拖拽中的股票项会显示虚线边框和半透明效果
- 目标分组标签页会高亮显示（蓝色渐变背景 + 脉冲边框动画）
- 鼠标指针会显示"移动"图标

### 2. 分组内排序

在同一个分组内，可以通过拖拽改变股票的排序：

1. 拖拽股票项
2. 放置到目标位置的其他股票项上
3. 自动调整排序

### 3. 用户提示

系统提供了多处用户提示：

#### 提示横幅
当有多个分组时，收藏列表顶部会显示提示横幅：
```
💡 提示：拖拽股票到分组标签页可以移动到其他分组
```

#### 拖拽手柄提示
鼠标悬停在拖拽手柄上时，显示完整提示：
```
拖拽到其他股票上进行排序，或拖拽到分组标签页进行分组
```

#### 空分组提示
空分组会显示使用提示：
```
该分组暂无收藏股票
💡 提示：拖拽股票到上方的 分组标签页 即可移动到该分组
```

## 技术实现

### JavaScript 改进

1. **改进拖拽高亮逻辑**（`setupDragAndDrop()`）
   - 只在拖拽到不同分组时显示高亮
   - 改进 `dragleave` 事件的边界检测
   - 添加 `.dragging` 类来控制视觉效果

2. **拖拽状态管理**
   - `dragstart`: 添加 `.dragging` 类，设置拖拽数据
   - `dragend`: 移除所有高亮状态，清理拖拽数据
   - `dragover`: 高亮目标分组标签页
   - `drop`: 执行移动操作

### CSS 样式增强

1. **拖拽中的股票样式**
```css
.favorite-item.dragging {
    opacity: 0.5;
    transform: scale(0.95);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    border: 2px dashed var(--color-primary);
}
```

2. **分组标签页高亮**
```css
.group-tab.drag-over {
    background: linear-gradient(135deg, var(--color-primary-light), #e0f2fe);
    border: 2px solid var(--color-primary);
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    animation: pulse-border 1s ease-in-out infinite;
}
```

3. **脉冲边框动画**
```css
@keyframes pulse-border {
    0%, 100% {
        border-color: var(--color-primary);
    }
    50% {
        border-color: #60a5fa;
    }
}
```

4. **提示横幅样式**
```css
.drag-tip-banner {
    background: linear-gradient(135deg, #eff6ff, #dbeafe);
    border: 1px solid #93c5fd;
    border-radius: var(--radius-md);
    padding: var(--spacing-sm) var(--spacing-md);
    margin-bottom: var(--spacing-md);
}
```

## 用户体验改进

1. ✅ **视觉反馈明显**：拖拽过程中有清晰的视觉提示
2. ✅ **操作提示完善**：多处用户提示说明如何使用
3. ✅ **交互流畅**：添加过渡动画和悬停效果
4. ✅ **错误预防**：只有不同分组时才显示高亮，避免混淆

## 为什么不能拖拽到隐藏的分组内容区域

使用 `display: none` 隐藏的元素：
- ❌ 无法接收任何鼠标事件（包括拖拽事件）
- ❌ 不占据页面布局空间
- ❌ 完全从渲染树中移除

**替代方案**：
- ✅ 拖拽到始终可见的分组标签页
- ❌ 使用 `visibility: hidden`（会占据空间但不可交互）
- ❌ 使用绝对定位（所有内容会叠在一起）

因此，**拖拽到分组标签页**是最佳解决方案。

## 测试建议

### 手动测试步骤

1. **创建多个分组**
   - 点击"➕ 新建分组"创建至少2个分组
   
2. **添加多个收藏**
   - 在不同分组中添加若干股票

3. **测试分组内排序**
   - 在同一分组内拖拽股票，验证排序是否正确

4. **测试跨分组移动**
   - 拖拽股票到其他分组的标签页
   - 验证是否成功移动
   - 检查视觉反馈是否清晰

5. **测试空分组**
   - 创建一个空分组
   - 拖拽股票到该分组的标签页
   - 验证是否成功添加

6. **测试视觉效果**
   - 检查拖拽手柄的显示
   - 检查拖拽中的样式
   - 检查标签页高亮效果
   - 检查提示横幅的显示

### 浏览器兼容性

该功能使用标准的HTML5拖拽API，支持：
- ✅ Chrome/Edge 90+
- ✅ Firefox 88+
- ✅ Safari 14+
- ❌ 移动端浏览器（触摸拖拽需要额外实现）

## 未来改进方向

1. **移动端支持**：实现触摸拖拽功能
2. **批量移动**：支持选择多个股票一起移动
3. **拖拽预览**：显示自定义的拖拽预览图像
4. **撤销功能**：支持撤销误操作的移动
5. **键盘支持**：使用键盘快捷键进行移动和排序

## 相关文件

### JavaScript
- `web/static/js/modules/favorites.js`
  - `setupDragAndDrop()`: 拖拽功能初始化
  - `handleDrop()`: 处理拖拽放置
  - `moveFavoriteToGroup()`: 移动到其他分组
  - `reorderWithinGroup()`: 分组内排序

### CSS
- `web/static/styles.css`
  - `.favorite-item.dragging`: 拖拽中的样式
  - `.group-tab.drag-over`: 分组标签页高亮
  - `.drag-tip-banner`: 提示横幅样式
  - `@keyframes pulse-border`: 脉冲动画

### 后端API
- `PUT /api/favorites/order`: 更新收藏排序和分组
  - 参数：`[{id, group_id, sort_order}]`
  - 返回：更新结果

## 常见问题

### Q: 为什么不能直接拖拽到分组内容区域？
A: 因为非激活的分组使用 `display: none` 隐藏，无法接收拖拽事件。拖拽到标签页是最佳替代方案。

### Q: 拖拽手柄看不见怎么办？
A: 鼠标悬停在股票项上时，拖拽手柄会变得更明显（完全不透明 + 蓝色）。

### Q: 如何知道拖拽成功了？
A: 松开鼠标后，系统会显示成功提示消息，并自动刷新列表。

### Q: 拖拽时误操作怎么办？
A: 可以按 ESC 键或将股票拖拽回原分组来取消操作。

### Q: 移动端能用吗？
A: 目前移动端不支持拖拽功能，可以使用长按菜单等方式作为替代方案（待开发）。

