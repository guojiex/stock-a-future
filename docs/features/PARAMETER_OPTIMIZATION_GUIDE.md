# 策略参数优化功能使用指南

## 📋 功能概述

参数优化功能允许您自动测试不同的策略参数组合，找到在历史数据上表现最佳的参数配置，从而提升策略的盈利能力和稳定性。

## 🎯 主要特性

- ✅ **网格搜索**：穷举所有参数组合，精确找到最优解
- ✅ **遗传算法**：智能搜索，快速找到接近最优的解决方案
- ✅ **多种优化目标**：支持夏普比率、总收益率、胜率、盈亏比等
- ✅ **实时进度监控**：查看优化过程和当前最佳参数
- ✅ **详细结果分析**：查看所有测试组合的性能对比
- ✅ **一键应用**：优化完成后可直接应用最佳参数

## 🚀 使用方法

### 1. 进入策略管理页面

导航到 `/strategies` 页面，找到您想要优化的策略。

### 2. 点击参数优化按钮

在策略卡片上找到 **参数优化** 按钮（齿轮图标），点击打开优化对话框。

### 3. 选择优化算法

#### 网格搜索
- **优点**：穷举所有组合，保证找到最优解
- **缺点**：参数空间较大时耗时较长
- **适用场景**：参数较少（2-3个），每个参数可选值不超过10个

#### 遗传算法
- **优点**：搜索速度快，适合大参数空间
- **缺点**：可能得到局部最优而非全局最优
- **适用场景**：参数较多或参数范围较广

### 4. 配置参数范围

系统会根据策略当前参数自动生成合理的搜索范围，您也可以手动调整：

- **最小值**：参数搜索的下界
- **最大值**：参数搜索的上界
- **步长**：网格搜索时的参数间隔（遗传算法自动处理）

**示例**：
```
参数: fast_period (当前值: 12)
- 最小值: 6
- 最大值: 18
- 步长: 2
- 结果: 将测试 6, 8, 10, 12, 14, 16, 18 这7个值
```

### 5. 选择优化目标

根据您的投资策略选择合适的优化目标：

- **夏普比率**（推荐）：综合考虑收益和风险，适合大多数情况
- **总收益率**：追求最高收益，不考虑波动风险
- **胜率**：优化交易成功率
- **盈亏比**：优化盈利交易的平均收益与亏损交易的平均损失比

### 6. 配置回测参数

- **开始日期**：回测的起始日期
- **结束日期**：回测的结束日期
- **初始资金**：回测的初始资金量（默认100万）
- **手续费率**：交易手续费（默认0.03%）
- **股票选择**：从收藏列表或搜索结果中选择股票

**股票选择方式**：
1. **从收藏列表添加**
   - 点击"添加所有收藏"快速添加所有已收藏的股票
   - 或点击"搜索添加"展开选择器，从收藏列表中逐个选择

2. **搜索添加**
   - 点击"搜索添加"按钮
   - 在搜索框输入股票名称或代码（至少2个字符）
   - 从搜索结果中点击"+"按钮添加

3. **管理已选股票**
   - 已选股票以标签形式显示
   - 点击标签上的"×"可以移除股票
   - 支持同时选择多只股票

**建议**：
- 使用至少1年的历史数据
- 选择5-10只具有代表性的股票
- 包含不同行业和市值的股票
- 优先从收藏列表选择，这些是你已经关注的股票

### 7. 启动优化

点击"开始优化"按钮，系统将：

1. 生成所有参数组合
2. 逐一进行回测
3. 计算每组参数的得分
4. 实时显示进度和当前最佳参数

### 8. 查看结果

优化完成后，您可以查看：

#### 最佳参数标签
- 显示得分最高的参数组合
- 包含每个参数的最优值

#### 性能指标标签
- 总收益率
- 年化收益
- 夏普比率
- 最大回撤
- 胜率
- 交易次数

#### 所有结果标签
- 按得分排序的所有测试组合
- 可以对比不同参数的性能差异
- 最多显示前50个结果

### 9. 应用最佳参数

点击"应用最佳参数"按钮，系统会：
1. 更新策略的参数配置
2. 保存修改
3. 刷新策略列表

## 🔧 算法配置

### 网格搜索配置

| 参数 | 说明 | 默认值 | 建议范围 |
|------|------|--------|----------|
| 最大组合数 | 限制测试的参数组合数量 | 100 | 50-500 |

**组合数量估算**：
```
总组合数 = 参数1选项数 × 参数2选项数 × ... × 参数N选项数

例如：
fast_period: 10-20, step=2  → 6个选项
slow_period: 20-40, step=5  → 5个选项
signal_period: 5-15, step=2 → 6个选项
总组合数 = 6 × 5 × 6 = 180 组
```

### 遗传算法配置

| 参数 | 说明 | 默认值 | 建议范围 |
|------|------|--------|----------|
| 种群大小 | 每代的个体数量 | 50 | 30-100 |
| 迭代代数 | 算法运行的代数 | 20 | 10-50 |
| 变异率 | 基因变异的概率 | 0.1 | 0.05-0.2 |
| 交叉率 | 基因交叉的概率 | 0.7 | 0.6-0.9 |

**总测试数量** = 种群大小 × 迭代代数

## 📊 性能优化建议

### 1. 参数范围设置

❌ **不推荐**：范围过大
```
fast_period: 1-100, step=1  → 100个选项（太多）
```

✅ **推荐**：合理范围
```
fast_period: 8-16, step=2   → 5个选项（适中）
```

### 2. 回测时间段

- 短期优化（快速测试）：3-6个月
- 中期优化（平衡）：1-2年
- 长期优化（稳健）：3-5年

### 3. 股票选择

- 最少：3只股票（快速但不够准确）
- 推荐：5-10只股票（平衡）
- 最多：20只股票（准确但较慢）

**提示**：
- 使用"添加所有收藏"功能快速选择多只股票
- 通过搜索功能精确添加特定股票
- 根据不同行业和市值分散选择，提高结果可靠性

### 4. 算法选择决策树

```
参数数量 ≤ 3 且 总组合数 ≤ 500
    ↓
使用网格搜索（精确）

参数数量 > 3 或 总组合数 > 500
    ↓
使用遗传算法（快速）
```

## ⚠️ 注意事项

### 过度拟合风险

参数优化可能导致过度拟合历史数据，在实际交易中表现不佳。

**预防措施**：
1. 使用样本外数据验证
2. 避免过度优化（参数范围不要太窄）
3. 定期重新优化参数
4. 观察参数的稳定性

### 计算资源

- 优化过程需要大量计算
- 建议在非交易时间运行
- 可能需要10分钟至数小时
- 避免同时运行多个优化任务

### 数据质量

- 确保历史数据完整
- 包含不同市场环境（牛市、熊市、震荡市）
- 考虑交易成本和滑点

## 🎓 最佳实践

### 1. 分阶段优化

```
第一阶段：粗调（大范围、大步长）
  fast_period: 5-25, step=5

第二阶段：精调（小范围、小步长）
  fast_period: 10-14, step=1  (基于第一阶段结果)
```

### 2. 多目标验证

不要只看单一指标，综合评估：
- 收益率要高
- 回撤要小
- 胜率要合理（50%以上）
- 交易次数要适中（不要太频繁）

### 3. 定期重优化

建议每季度或半年重新优化一次参数，适应市场变化。

### 4. 参数敏感性分析

关注参数变化对结果的影响：
- 如果微小变化导致性能大幅波动 → 参数不稳定
- 如果大范围变化性能相对稳定 → 参数鲁棒性好

## 🔗 API接口

### 启动参数优化

```http
POST /api/v1/strategies/{strategy_id}/optimize
Content-Type: application/json

{
  "parameter_ranges": {
    "fast_period": {"min": 10, "max": 14, "step": 1},
    "slow_period": {"min": 20, "max": 30, "step": 2}
  },
  "optimization_target": "sharpe_ratio",
  "symbols": ["000001.SZ", "600000.SH"],
  "start_date": "2024-01-01",
  "end_date": "2024-12-31",
  "initial_cash": 1000000,
  "commission": 0.0003,
  "algorithm": "grid_search",
  "max_combinations": 100
}
```

### 查询优化进度

```http
GET /api/v1/optimizations/{optimization_id}/progress
```

### 获取优化结果

```http
GET /api/v1/optimizations/{optimization_id}/results
```

### 取消优化任务

```http
POST /api/v1/optimizations/{optimization_id}/cancel
```

## 📈 示例场景

### 场景1：MACD策略优化

**目标**：找到最佳的MACD参数

```yaml
参数配置:
  fast_period: 10-14, step=1
  slow_period: 24-30, step=2
  signal_period: 7-11, step=1

算法: 网格搜索
优化目标: 夏普比率
回测周期: 2年
股票池: 10只蓝筹股

预期结果:
  - 测试 5 × 4 × 3 = 60 组参数
  - 耗时约 10-15 分钟
  - 找到夏普比率最高的参数组合
```

### 场景2：双均线策略优化

**目标**：快速找到较优参数

```yaml
参数配置:
  short_period: 3-10, 连续值
  long_period: 15-30, 连续值
  threshold: 0.005-0.02, 连续值

算法: 遗传算法
  种群大小: 50
  迭代代数: 30
优化目标: 总收益率
回测周期: 1年
股票池: 5只科技股

预期结果:
  - 测试 50 × 30 = 1500 组参数
  - 耗时约 30-45 分钟
  - 找到收益率较高的参数组合
```

## 🆘 常见问题

### Q1: 优化失败怎么办？

**解决方法**：
1. 检查参数范围是否合理
2. 确认股票代码格式正确
3. 减少参数组合数量
4. 查看系统日志获取详细错误信息

### Q2: 优化时间太长？

**解决方法**：
1. 减少参数范围或增加步长
2. 减少股票数量
3. 缩短回测周期
4. 使用遗传算法代替网格搜索
5. 降低最大组合数限制

### Q3: 优化结果不理想？

**可能原因**：
1. 参数范围设置不当
2. 回测周期不够长
3. 股票选择不具代表性
4. 策略逻辑本身有问题

**改进建议**：
1. 扩大或调整参数范围
2. 延长回测周期
3. 增加股票数量和多样性
4. 检查策略实现逻辑

### Q4: 如何验证优化效果？

**验证方法**：
1. 使用样本外数据测试（不同时间段）
2. 在不同股票上测试
3. 进行模拟交易验证
4. 对比优化前后的性能差异

## 📚 相关文档

- [策略创建指南](./STRATEGY_CREATION_DESIGN.md)
- [回测系统设计](../architecture/BACKTEST_SYSTEM_DESIGN.md)
- [策略管理文档](./STRATEGY_MANAGEMENT.md)

## 🔄 更新日志

### v1.0.0 (2025-10-28)
- ✅ 实现网格搜索算法
- ✅ 实现遗传算法
- ✅ 支持多种优化目标
- ✅ 实时进度监控
- ✅ 结果可视化展示
- ✅ 一键应用最佳参数

---

**提示**：参数优化是提升策略性能的重要工具，但请记住，历史表现不代表未来收益。请结合实际情况，谨慎使用优化结果。

