# 服务器管理指南

本文档介绍如何使用 Make 命令管理 Stock-A-Future 服务器。

## 🚀 服务器管理命令

### 启动服务器

#### 开发模式启动
```bash
make dev
```
- 直接运行源代码，无需构建
- 适合开发和调试
- 代码修改后需要重新启动

#### 构建后启动
```bash
make run
```
- 先构建二进制文件，再启动
- 适合生产环境
- 性能更好

### 停止服务器

#### 优雅停止
```bash
make stop
```
- 发送 TERM 信号，允许服务器优雅关闭
- 推荐的停止方式
- 会等待当前请求处理完成

#### 强制停止
```bash
make kill
```
- 发送 KILL 信号，立即终止进程
- 仅在优雅停止失败时使用
- 可能导致数据丢失

### 重启服务器
```bash
make restart
```
- 等效于 `make stop && make dev`
- 先停止服务器，再以开发模式启动
- 自动处理进程清理

### 检查服务器状态
```bash
make status
```
显示以下信息：
- ✅ 服务器运行状态
- 📋 运行中的进程列表
- 🔌 监听的端口信息

## 📝 使用示例

### 日常开发流程

1. **启动开发服务器**
   ```bash
   make dev
   ```

2. **修改代码后重启**
   ```bash
   make restart
   ```

3. **检查服务器状态**
   ```bash
   make status
   ```

4. **工作结束后停止**
   ```bash
   make stop
   ```

### 故障排除

#### 端口被占用
```bash
# 检查端口占用
make status

# 强制停止所有相关进程
make kill

# 重新启动
make dev
```

#### 服务器无响应
```bash
# 检查进程状态
make status

# 强制重启
make kill
make dev
```

## 🔧 技术细节

### 进程识别
命令通过以下模式识别服务器进程：
- `go run.*cmd/server` - 开发模式进程
- `stock-a-future` - 构建后的二进制文件

### 端口检测
- 默认监听端口：`8081`
- 使用 `lsof` 命令检查端口占用
- 自动显示监听该端口的进程信息

### 信号处理
- **TERM (15)**: 优雅停止，允许清理资源
- **KILL (9)**: 强制终止，立即停止进程

## ⚠️ 注意事项

1. **数据安全**
   - 使用 `make stop` 而非 `make kill`
   - 确保重要操作完成后再停止服务器

2. **开发环境**
   - 代码修改后需要重启服务器
   - 使用 `make restart` 快速重启

3. **生产环境**
   - 建议使用 `make run` 启动
   - 配置进程管理工具（如 systemd）

4. **端口冲突**
   - 确保 8081 端口未被其他程序占用
   - 可通过环境变量修改端口配置

## 📊 命令对照表

| 命令 | 用途 | 适用场景 | 注意事项 |
|------|------|----------|----------|
| `make dev` | 开发模式启动 | 日常开发 | 代码修改需重启 |
| `make run` | 生产模式启动 | 生产部署 | 需先构建 |
| `make stop` | 优雅停止 | 正常停止 | 推荐方式 |
| `make kill` | 强制停止 | 紧急情况 | 可能丢数据 |
| `make restart` | 重启服务器 | 代码更新 | 自动化流程 |
| `make status` | 检查状态 | 故障排查 | 显示详细信息 |

## 🆘 常见问题

**Q: 服务器启动失败，提示端口被占用？**
A: 运行 `make status` 检查，然后 `make stop` 或 `make kill` 清理进程。

**Q: 修改代码后没有生效？**
A: 开发模式需要重启，运行 `make restart`。

**Q: 如何确认服务器正在运行？**
A: 运行 `make status`，或访问 `http://localhost:8081/api/v1/health`。

**Q: 服务器无法正常停止？**
A: 先尝试 `make stop`，如果失败则使用 `make kill`。

---

*更新时间: 2025年1月*
